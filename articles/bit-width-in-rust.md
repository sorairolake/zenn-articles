---
title: "Rustã§æ•´æ•°ã‚’è¡¨ã™ã®ã«å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã‚’æ±‚ã‚ã‚‹"
emoji: "ğŸ¦€"
type: "tech"
topics: ["rust"]
published: true
---

## ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯ã€[Rust](https://www.rust-lang.org/)ã§[Python](https://www.python.org/)ã®[`int.bit_length()`](https://docs.python.org/ja/3.13/library/stdtypes.html#int.bit_length)ã®ã‚ˆã†ã«æ•´æ•°ã‚’è¡¨ã™ã®ã«å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã‚’æ±‚ã‚ã‚‹æ–¹æ³•ã«ã¤ã„ã¦æ›¸ã„ãŸã‚‚ã®ã§ã™ã€‚

:::message
ç´¹ä»‹ã™ã‚‹æ–¹æ³•ã¯ä¸»ã«Rust 1.67.0ä»¥é™ã§åˆ©ç”¨ã§ãã¾ã™ã€‚
:::

:::message
ç´¹ä»‹ã™ã‚‹æ–¹æ³•ã«ã¯é–“é•ã„ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€å®Ÿéš›ã«ä½¿ç”¨ã™ã‚‹å ´åˆã«ã¯äº‹å‰ã«æ¤œè¨¼ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
:::

## è‡ªç„¶æ•°ã®å ´åˆ

æ•´æ•°$n$ãŒ$n > 0$ã§ã‚ã‚‹ã¨ãã€`n.ilog2() + 1`ã§$n$ã‚’è¡¨ã™ã®ã«å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
let answer: u8 = 42;
assert_eq!(answer.ilog2() + 1, 6);
```

[`ilog2()`](https://doc.rust-lang.org/std/primitive.i32.html#method.ilog2)ã¯$n \leqq 0$ã§ã‚ã‚‹ã¨ãã¯ãƒ‘ãƒ‹ãƒƒã‚¯ã—ã¾ã™ã€‚
$n \leqq 0$ãªå¯èƒ½æ€§ãŒã‚ã‚‹ã¨ãã¯ã€`Option<T>`ã‚’è¿”ã™[`checked_ilog2()`](https://doc.rust-lang.org/std/primitive.i32.html#method.checked_ilog2)ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ãƒ‘ãƒ‹ãƒƒã‚¯ã‚’é¿ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
let answer: u8 = 42;
assert_eq!(answer.checked_ilog2().map(|n| n + 1), Some(6));
assert!(0_u8.checked_ilog2().is_none());
```

`ilog2`ã‚„`checked_ilog2`ã¯Rust 1.67.0ã§å®‰å®šåŒ–ã•ã‚Œã¾ã—ãŸã€‚
ãã‚Œä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãã®å‹ã®ãƒ“ãƒƒãƒˆæ•°ï¼ˆ`32`ï¼‰ã‹ã‚‰[`leading_zeros()`](https://doc.rust-lang.org/std/primitive.u32.html#method.leading_zeros)ã§å¾—ãŸå€¤ã‚’äºŒé€²æ•°ã§è¡¨ç¾ã—ãŸã¨ãã®å…ˆé ­ã®`0`ã®æ•°ã‚’å¼•ãã“ã¨ã§åŒæ§˜ã®çµæœã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚

```rust
let answer: u32 = 42;
let old = 32 - answer.leading_zeros();
let new = answer.ilog2() + 1;
assert_eq!(old, new);
```

`32`ã¨ã„ã†ãƒã‚¸ãƒƒã‚¯ãƒŠãƒ³ãƒãƒ¼ã¯ã€Rust 1.53.0ã§å®‰å®šåŒ–ã•ã‚ŒãŸãã®å‹ã®ãƒ“ãƒƒãƒˆæ•°ã‚’è¡¨ã™[`BITS`](https://doc.rust-lang.org/std/primitive.u32.html#associatedconstant.BITS)é–¢é€£å®šæ•°ã§ç½®ãæ›ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

$n = 0$ã‚‚å«ã‚ãŸå…¨ã¦ã®ç¬¦å·ç„¡ã—æ•´æ•°ã§å€¤ã‚’è¡¨ã™ã®ã«å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã¯ã€ä»¥ä¸‹ã®æ–¹æ³•ã§æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
let n = u32::MIN;
assert_eq!(n.checked_ilog2().map_or(0, |n| n + 1), 0);
```

ç¬¦å·ä»˜ãæ•´æ•°ã§ç¬¦å·ãƒ“ãƒƒãƒˆã‚‚å«ã‚ã¦å€¤ã‚’è¡¨ã™ã®ã«å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã¯ã€æœ€åˆã®æ–¹æ³•ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹ã“ã¨ã§æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```diff rust
let answer: i8 = 42;
-assert_eq!(answer.ilog2() + 1, 6);
+assert_eq!(answer.ilog2() + 2, 7);
```

## è² ã®æ•´æ•°ã®å ´åˆ

Pythonã®`int.bit_length()`ã®ã‚ˆã†ã«ç¬¦å·ã‚’é™¤ã„ãŸè² ã®æ•´æ•°$n$ã‚’è¡¨ã™ã®ã«å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã‚’æ±‚ã‚ãŸã„ã¨ãï¼ˆ$-37$ã®ã¨ãã¯$37$ï¼‰ã€$n \neq 0$ã§ã‚ã‚‹ã¨ãã¯`n.unsigned_abs().ilog2() + 1`ã§æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
let n: i32 = -37;
assert_eq!(n.unsigned_abs().ilog2() + 1, 6);
```

æ®†ã©ã®å ´åˆã¯[`abs()`](https://doc.rust-lang.org/std/primitive.i32.html#method.abs)ã§å•é¡Œãªã„ã§ã™ãŒã€$n$ãŒ[`i32::MIN`](https://doc.rust-lang.org/std/primitive.i32.html#associatedconstant.MIN)ãªã©ã®ãã®å‹ã®æœ€å°å€¤ã®ã¨ãã«ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§ã€[`unsigned_abs()`](https://doc.rust-lang.org/std/primitive.i32.html#method.unsigned_abs)ã‚’ä½¿ã†æ–¹ãŒå®‰å…¨ã§ã™ã€‚

ç¬¦å·ãƒ“ãƒƒãƒˆã‚‚å«ã‚ãŸè² ã®æ•´æ•°$n$ã‚’è¡¨ã™ã®ã«å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã‚’æ±‚ã‚ãŸã„ã¨ãã€$n < -1$ã§ã‚ã‚‹ã¨ãã¯`(n + 1).abs().ilog2() + 2`ã§æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
let n: i16 = -128;
assert_eq!((n + 1).abs().ilog2() + 2, 8);

let m: i16 = -129;
assert_eq!((m + 1).abs().ilog2() + 2, 9);
```

$n \geqq -1$ãªå¯èƒ½æ€§ãŒã‚ã‚‹ã¨ãã¯ã€`checked_ilog2()`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§è‡ªç„¶æ•°ã®å ´åˆã¨åŒæ§˜ã«ãƒ‘ãƒ‹ãƒƒã‚¯ã‚’é¿ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

$n = 0$ã¨$n = -1$ã‚‚å«ã‚ãŸå…¨ã¦ã®ç¬¦å·ä»˜ãæ•´æ•°ã§å€¤ã‚’è¡¨ã™ã®ã«å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã¯ã€ä»¥ä¸‹ã®æ–¹æ³•ã§æ±‚ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
let n: i32 = -1;
let bit_width = match n {
    0 | -1 => 0,
    n if n.is_positive() => n.ilog2() + 2,
    n => (n + 1).abs().ilog2() + 2,
};
assert_eq!(bit_width, 0);
```

## çµ‚ã‚ã‚Šã«

ç´¹ä»‹ã—ãŸæ–¹æ³•ã ã¨$n = 0$ã¾ãŸã¯$n = -1$ã®ã¨ãã¯å¿…è¦ãªãƒ“ãƒƒãƒˆæ•°ã‚’æ±‚ã‚ã‚‹ã“ã¨ãŒã§ããªã„ã®ã§ã€ã“ã‚Œã‚‰ã®å ´åˆã«ã‚‚å¯¾å¿œã—ãŸã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
